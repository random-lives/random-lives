---
layout: default
title: Map View
---

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">

<style>
#world-map {
  height: 600px;
  width: 100%;
  border: 1px solid #e0e0e0;
  border-radius: 4px;
  background: #f5f5f5;
}

.map-view {
  padding-bottom: 40px;
}

.map-view h1 {
  font-size: 2.2rem;
  font-weight: 600;
  margin-bottom: 12px;
  letter-spacing: -0.02em;
}

.map-popup {
  font-size: 0.9rem;
  line-height: 1.5;
}

.map-popup a {
  color: #000;
  text-decoration: none;
}

.map-popup a:hover {
  text-decoration: underline;
}

.popup-years {
  color: #666;
}

.popup-country {
  color: #888;
  font-size: 0.85rem;
}

.map-controls {
  margin-bottom: 16px;
}

.map-controls-row {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.map-controls label {
  font-size: 0.9rem;
  color: #666;
  margin-right: 4px;
}

.color-btn {
  padding: 5px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  background: #fff;
  color: #555;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.15s;
  font-family: inherit;
}

.color-btn:hover {
  border-color: #bbb;
  background: #f5f5f5;
}

.color-btn.selected {
  background: #333;
  border-color: #333;
  color: #fff;
}

.legend {
  display: flex;
  flex-wrap: wrap;
  gap: 8px 24px;
  font-size: 0.8rem;
  color: #555;
  margin-top: 12px;
  min-height: 44px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 5px;
  white-space: nowrap;
}

.legend-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}

@media (max-width: 600px) {
  #world-map {
    height: 400px;
  }
}
</style>

<div class="map-view">
  <h1>All Lives</h1>

  <div class="view-switcher">
    <a href="{{ '/lives' | relative_url }}">List</a>
    <a href="{{ '/map' | relative_url }}" class="active">Map</a>
    <a href="{{ '/timeline' | relative_url }}">Timeline</a>
  </div>

  <div class="map-controls">
    <div class="map-controls-row">
      <label>Color by:</label>
      <button type="button" class="color-btn" data-value="lifestyle">Lifestyle</button>
      <button type="button" class="color-btn" data-value="era">Era</button>
      <button type="button" class="color-btn" data-value="age">Age at death</button>
    </div>
    <div id="legend" class="legend"></div>
  </div>

  <div id="world-map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
(function() {
  const map = L.map('world-map', {
    zoomControl: true,
    attributionControl: false,
    minZoom: 2,
    zoomSnap: 0.1,
    maxBounds: [[-85, -200], [85, 200]],
    maxBoundsViscosity: 1.0
  }).setView([31.1, 11.1], 2);

  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    minZoom: 2
  }).addTo(map);

  const lives = [
    {% assign first = true %}
    {% for life in site.lives %}
    {% if life.latitude and life.longitude %}
    {% unless first %},{% endunless %}
    {% assign first = false %}
    {
      name: "{{ life.title | escape }}",
      lat: {{ life.latitude }},
      lng: {{ life.longitude }},
      url: "{{ life.url | relative_url }}",
      years: "{% if life.birth_year == life.death_year %}{{ life.birth_year }}{% else %}{{ life.birth_year }} – {{ life.death_year }}{% endif %}",
      country: "{% if life.country %}{{ life.country | escape }}{% else %}{{ life.subregion | escape }}{% endif %}",
      birthYear: {{ life.birth_year_numeric }},
      ageTag: "{{ life.age_tag }}",
      lifestyle: "{{ life.lifestyle | escape }}"
    }
    {% endif %}
    {% endfor %}
  ];

  // Color schemes
  const ageColors = {
    'Alive': '#22c55e',
    'Infant (0–1)': '#ef4444',
    'Child (2–10)': '#f97316',
    'Adolescent (11–18)': '#eab308',
    'Adult (19–49)': '#3b82f6',
    'Elder (50+)': '#8b5cf6',
    'Elder (70+)': '#8b5cf6'
  };

  // Legend only shows canonical age categories
  const ageLegendColors = {
    'Alive': '#22c55e',
    'Infant (0–1)': '#ef4444',
    'Child (2–10)': '#f97316',
    'Adolescent (11–18)': '#eab308',
    'Adult (19–49)': '#3b82f6',
    'Elder (50+)': '#8b5cf6'
  };

  const eraColors = {
    'Prehistoric (before 3000 BC)': '#7c3aed',
    'Ancient (3000 BC – 500 AD)': '#dc2626',
    'Medieval (500 – 1500)': '#f59e0b',
    'Early Modern (1500 – 1800)': '#0ea5e9',
    'Modern (1800+)': '#22c55e'
  };

  const lifestyleColors = {
    'Hunter-Gatherer': '#8b5cf6',
    'Pastoralist': '#f59e0b',
    'Farmer': '#22c55e',
    'Rural Non-Farm': '#06b6d4',
    'Urban': '#ef4444'
  };

  function getEra(birthYear) {
    if (birthYear < -3000) return 'Prehistoric (before 3000 BC)';
    if (birthYear < 500) return 'Ancient (3000 BC – 500 AD)';
    if (birthYear < 1500) return 'Medieval (500 – 1500)';
    if (birthYear < 1800) return 'Early Modern (1500 – 1800)';
    return 'Modern (1800+)';
  }

  function getColor(life, colorBy) {
    if (colorBy === 'age') {
      return ageColors[life.ageTag] || '#000';
    } else if (colorBy === 'era') {
      return eraColors[getEra(life.birthYear)] || '#000';
    } else if (colorBy === 'lifestyle') {
      return lifestyleColors[life.lifestyle] || '#000';
    }
    return '#000';
  }

  // HYDE grid resolution: 5 arcminutes = ~9.2 km at equator = ~4.6 km radius
  const HYDE_RADIUS_METERS = 4600;
  const ZOOM_THRESHOLD = 8; // Show uncertainty circles at zoom 8+

  // Create markers (both dots and uncertainty circles)
  const markers = [];
  lives.forEach(life => {
    // Circle marker (dot) for low zoom levels - visual only
    const dot = L.circleMarker([life.lat, life.lng], {
      radius: 5,
      fillColor: "#000",
      color: "#fff",
      weight: 1,
      opacity: 1,
      fillOpacity: 0.9,
      interactive: false,
      bubblingMouseEvents: false
    });

    // Invisible larger hit area for easier clicking (added after dot so it's on top)
    const hitArea = L.circleMarker([life.lat, life.lng], {
      radius: 10,
      fillColor: "#000",
      color: "#000",
      weight: 0,
      opacity: 0,
      fillOpacity: 0
    });

    // Circle (uncertainty region) for high zoom levels
    const circle = L.circle([life.lat, life.lng], {
      radius: HYDE_RADIUS_METERS,
      fillColor: "#000",
      color: "#fff",
      weight: 2,
      opacity: 1,
      fillOpacity: 0.3
    });

    const popup = L.popup().setContent(`
      <div class="map-popup">
        <strong><a href="${life.url}">${life.name}</a></strong><br>
        <span class="popup-years">${life.years}</span><br>
        <span class="popup-country">${life.country}</span>
      </div>
    `);

    hitArea.bindPopup(popup);
    circle.bindPopup(popup);

    // Start with dots visible (dot first, then hitArea on top for clicks)
    dot.addTo(map);
    hitArea.addTo(map);

    markers.push({ dot, hitArea, circle, life });
  });

  // Update colors
  function updateColors(colorBy) {
    markers.forEach(({ dot, circle, life }) => {
      const color = getColor(life, colorBy);
      dot.setStyle({ fillColor: color });
      circle.setStyle({ fillColor: color });
    });
    updateLegend(colorBy);
  }

  // Switch between dots and circles based on zoom level
  function updateMarkerDisplay() {
    const zoom = map.getZoom();
    const showCircles = zoom >= ZOOM_THRESHOLD;

    markers.forEach(({ dot, hitArea, circle }) => {
      if (showCircles) {
        if (map.hasLayer(dot)) map.removeLayer(dot);
        if (map.hasLayer(hitArea)) map.removeLayer(hitArea);
        if (!map.hasLayer(circle)) map.addLayer(circle);
      } else {
        if (map.hasLayer(circle)) map.removeLayer(circle);
        if (!map.hasLayer(dot)) map.addLayer(dot);
        if (!map.hasLayer(hitArea)) map.addLayer(hitArea);
      }
    });
  }

  // Listen for zoom changes
  map.on('zoomend', updateMarkerDisplay);

  // Also call on initial load
  updateMarkerDisplay();

  // Update legend
  function updateLegend(colorBy) {
    const legend = document.getElementById('legend');
    if (colorBy === 'none') {
      legend.innerHTML = '';
      return;
    }

    const colors = colorBy === 'age' ? ageLegendColors : colorBy === 'lifestyle' ? lifestyleColors : eraColors;
    legend.innerHTML = Object.entries(colors).map(([label, color]) => `
      <div class="legend-item">
        <span class="legend-dot" style="background: ${color}"></span>
        <span>${label}</span>
      </div>
    `).join('');
  }

  // Event listeners for color buttons
  let colorBy = 'none';
  document.querySelectorAll('.color-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const value = btn.dataset.value;
      // Toggle: if already selected, deselect (go to none)
      if (btn.classList.contains('selected')) {
        btn.classList.remove('selected');
        colorBy = 'none';
      } else {
        // Deselect all, select this one
        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        colorBy = value;
      }
      updateColors(colorBy);
    });
  });

})();
</script>
